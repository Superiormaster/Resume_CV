{% extends "base.html" %}
{% block content %}

<div class="display1">
  <h2>Compose Resume</h2>
  <div class="display">
    <div class="left">
      <form method="post" id="resumeForm" action="{{ url_for('resume.save') }}" enctype="multipart/form-data">
          
          <input type="hidden" name="template" value="{{ selected_template }}">

          <div class="selected-template">
            <h4>Selected Template</h4>
          
            {% set name_no_ext = selected_template.rsplit('.', 1)[0] %}
            <img src="{{ url_for('static',
                filename='templates_preview/' ~ name_no_ext ~ '.png') }}"
                 style="max-width:200px">
          
            <p>{{ name_no_ext.replace('_', ' ').title() }}</p>
          
            <a href="{{ url_for('resume.templates') }}">Change template</a>
          </div>

        <label>Photo</label>
        <input type="file" name="photo" class="form-control" accept="image/*">

                <h4 class="mt-4">Personal Details</h4>
                <label>Full name </label><input name="full_name" class="form-control" required><br>

                <label>Job Title </label><input name="title" class="form-control"><br>

                <label>Email </label><input name="email" class="form-control" type="email" required><br>

                <label>Phone </label><input name="phone" class="form-control" ><br>

                <label>Website </label><input name="website" class="form-control" ><br>

                <label>LinkedIn </label><input name="linkedin" placeholder="https://..." class="form-control"><br>

                <label>Summary  </label><textarea name="summary" class="form-control" rows="4"></textarea><br>

                <label>Skills (comma separated) </label><input name="skills" class="form-control"><br>

                <h4 class="mt-4">Experience (up to 5)</h4>

                {% for i in range(1,6) %}

                <div class="exp mb-3">

                    <input name="exp_role_{{i}}" class="form-control mb-3" placeholder="Role">

                    <input name="exp_company_{{i}}" class="form-control mb-3" placeholder="Company">

                    <input name="exp_dates_{{i}}" class="form-control mb-3"  type="month" placeholder="Dates">

                    <textarea name="exp_desc_{{i}}" class="form-control mb-3" placeholder="Description"></textarea>

                </div>

                {% endfor %}

                <h4 class="mt-4">Education (up to 3)</h4>

                {% for i in range(1,4) %}

                <div class="edu">

                    <input name="edu_degree_{{i}}" class="form-control mb-3" placeholder="Degree">

                    <input name="edu_school_{{i}}" class="form-control mb-3" placeholder="School">

                    <input name="edu_years_{{i}}" type="month" class="form-control mb-3" placeholder="Years">

                </div>

                {% endfor %}

                <div class="btn-primary">

                    <button type="button" id="previewBtn">Live Preview</button>

                    <button type="submit">Save Resume</button>

                </div>

            </form>

        </div>

        <div class="right mt-4">

            <h2>Live Preview</h2>

            <iframe id="previewFrame" style="width: 100%; height:800px; border:1px solid #ccc;"></iframe>

        </div>

    </div>

</div>

</div>

<script>
let timeout;
async function updatePreview() {
  const form = document.getElementById('resumeForm');
  const data = new FormData(form);

  try {
    const resp = await fetch("{{ url_for('resume.preview') }}", {
      method: "POST",
      body: data
    });

    const j = await resp.json();
    const iframe = document.getElementById('previewFrame');
    iframe.srcdoc = j.html;
  } catch (err) {
    console.error("Preview error", err);
  }
}

    document.getElementById('previewBtn').addEventListener('click', updatePreview);
    document.getElementById('resumeForm').addEventListener('input', () => {
      clearTimeout(timeout);
      timeout = setTimeout(updatePreview, 600);
    });
    
    document.querySelector('input[name="photo"]').addEventListener('change', updatePreview);
    
    window.addEventListener('load', updatePreview);
</script>

{% endblock %}